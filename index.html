<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Isyarat To Text - Full Version</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #121212; color: white; margin: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }

        /* HEADER */
        .header { width: 100%; padding: 15px 30px; background: #1e1e1e; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; gap: 15px; flex-wrap: wrap;}
        .header-title { font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; gap: 10px; }
        .mode-select { background: #333; color: #fff; border: 1px solid #00e676; padding: 8px 12px; border-radius: 6px; font-weight: bold; cursor: pointer; outline: none;}
        .key-btn { background: #2979ff; border: none; color: white; padding: 8px 15px; font-size: 0.8rem; border-radius: 5px; cursor: pointer; font-weight:bold;}

        /* LAYOUT GRID */
        .main-wrapper { display: flex; flex-wrap: wrap; gap: 20px; width: 95%; max-width: 1300px; margin-top: 20px; justify-content: center; }
        .left-panel { flex: 1; min-width: 300px; max-width: 500px; }
        .right-panel { flex: 1.5; min-width: 400px; background: #1e1e1e; border-radius: 12px; border: 1px solid #333; display: flex; flex-direction: column; height: 550px; }

        /* VIDEO AREA */
        .video-box { position: relative; width: 100%; border: 2px solid #333; border-radius: 12px; overflow: hidden; background: #000; aspect-ratio: 4/3; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        video, canvas { width: 100%; height: 100%; display: block; transform: scaleX(-1); object-fit: cover; } 
        canvas { position: absolute; top: 0; left: 0; }

        /* OVERLAY */
        .overlay-status { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 10; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
        .overlay-status.active { opacity: 1; }
        .timer-bar { width: 60%; height: 8px; background: #444; margin-top: 15px; border-radius: 4px; overflow: hidden; }
        .timer-fill { height: 100%; background: #00e676; width: 0%; }

        /* SENTENCE BOX */
        .sentence-display { width: 95%; max-width: 1300px; margin-top: 20px; background: #1a1a1a; border: 1px solid #444; border-radius: 10px; padding: 15px 25px; text-align: left; display: flex; flex-direction: column;}
        .sentence-text { font-size: 2rem; font-weight: 800; color: #fff; margin-top: 5px; }

        /* TABLE */
        .table-container { flex: 1; overflow-y: auto; padding: 0; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; padding: 12px; color: #aaa; font-size: 0.8rem; border-bottom: 1px solid #444; position: sticky; top: 0; background: #252525; z-index: 2;}
        td { padding: 10px 12px; border-bottom: 1px solid #333; color: #ddd; vertical-align: middle; }
        .col-raw { color: #ffeb3b; font-weight: bold; font-size: 1.2rem; display: block; margin-bottom: 5px;}
        .view-capture-btn { background: #333; color: #bbb; border: 1px solid #555; font-size: 0.75rem; padding: 3px 8px; border-radius: 4px; cursor: pointer; text-decoration: none; display: inline-block;}
        .view-capture-btn:hover { background: #444; color: #fff; border-color: #888; }

        /* VALIDATION ROW */
        .candidates-row { display: flex; gap: 10px; align-items: flex-start; flex-wrap: wrap;}
        .candidate-item { text-align: center; background: #2a2a2a; padding: 5px; border-radius: 6px; border: 1px solid #444; min-width: 60px; }
        .candidate-item.winner { border-color: #00e676; background: #1b3a26; }
        .cand-img { width: 50px; height: 50px; object-fit: contain; background: #000; border-radius: 4px; margin-bottom: 4px; display: block; margin: 0 auto;}
        .cand-char { font-weight: bold; font-size: 1.1rem; color: #fff; display: block; }
        .cand-score { font-size: 0.75rem; color: #aaa; display: block; }
        .winner .cand-score { color: #00e676; font-weight: bold; }

        /* DICTIONARY */
        .dictionary-section { width: 95%; max-width: 1300px; margin-top: 30px; padding-bottom: 50px;}
        .dict-title { font-size: 1.2rem; font-weight: bold; color: #aaa; margin-bottom: 15px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .dict-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 10px; }
        .dict-item { background: #1e1e1e; border-radius: 8px; padding: 8px; text-align: center; border: 1px solid #333; transition: 0.2s; cursor: pointer;}
        .dict-item:hover { transform: scale(1.05); border-color: #00e676; }
        .dict-img { width: 100%; height: 50px; object-fit: contain; border-radius: 4px; background: #000; margin-bottom: 5px; }
        .dict-label { font-weight: bold; color: #fff; font-size: 1rem; }

        /* MODAL & KEY CONFIG */
        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.9); align-items: center; justify-content: center; }
        .key-modal-box { background: #1e1e1e; padding: 30px; border-radius: 15px; border: 1px solid #444; text-align: center; width: 450px; max-width: 90%; }
        .key-input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #555; background: #121212; color: #fff; box-sizing: border-box; font-size: 1rem; }
        .key-submit { width: 100%; padding: 12px; background: #00e676; color: #000; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; margin-top: 15px; }
        .check-btn { width: 100%; padding: 10px; background: #2979ff; color: #fff; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; }
        
        .model-list-select { width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; background: #2a2a2a; color: white; border: 1px solid #555; }
        .status-msg { font-size: 0.8rem; margin-top: 10px; }
        .success { color: #00e676; } .error { color: #ff5252; } .loading { color: #ffeb3b; }

        /* CAPTURE MODAL */
        .capture-content { max-width: 80%; max-height: 80%; border: 2px solid #00e676; border-radius: 10px; }
        .close-capture { position: absolute; top: 20px; right: 30px; color: #fff; font-size: 40px; cursor: pointer; }
        .modal-caption { position: absolute; bottom: 30px; color: white; background: rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 20px; font-size: 1.2rem;}

        /* SWITCH */
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; margin-left: 10px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #00e676; }
        input:checked + .slider:before { transform: translateX(24px); }
    </style>
</head>
<body>

    <div id="keyModal" class="modal" style="display: flex;">
        <div class="key-modal-box">
            <h2 style="margin-top:0;">üîë Konfigurasi AI</h2>
            <p style="color:#aaa; font-size:0.9rem;">Masukkan API Key Google Gemini Anda. Sistem akan mendeteksi model yang tersedia.</p>
            
            <input type="password" id="apiKeyInput" class="key-input" placeholder="Paste Gemini API Key here...">
            <button onclick="fetchModels()" class="check-btn" id="btnFetch">üîç LOAD DAFTAR MODEL</button>
            
            <div id="statusMsg" class="status-msg"></div>

            <div id="modelSelectionArea" style="display: none; text-align: left; margin-top: 20px;">
                <label style="color:#ccc; font-size:0.9rem;">Pilih Model AI:</label>
                <select id="aiModelSelect" class="model-list-select"></select>
                <button onclick="saveSettings()" class="key-submit">SIMPAN & JALANKAN</button>
            </div>

            <p style="font-size:0.8rem; color:#555; margin-top:15px;">
                <a href="https://aistudio.google.com/app/apikey" target="_blank" style="color:#00e676;">Dapatkan API Key Gratis</a>
            </p>
        </div>
    </div>

    <div id="captureModal" class="modal">
        <span class="close-capture" onclick="closeModal()">&times;</span>
        <img class="capture-content" id="modalImg">
        <div class="modal-caption">Foto yang dikirim ke AI</div>
    </div>

    <div class="header">
        <div class="header-title">
            <span>Agama kelompok 1</span>
            <select id="mode-select" class="mode-select">
                <option value="ALPHABET">üî§ Alfabet (A-Z + Validasi)</option>
                <option value="GENERAL">üåè General (Kata & Kalimat)</option>
            </select>
            <button onclick="changeKey()" class="key-btn" id="modelBadge">‚öôÔ∏è Setup</button>
        </div>
        <div style="display:flex; align-items:center;">
            <span style="font-size:0.9rem; color:#aaa;">AUTO SCAN:</span>
            <label class="switch">
                <input type="checkbox" id="live-toggle">
                <span class="slider"></span>
            </label>
        </div>
    </div>

    <div class="sentence-display">
        <div style="display:flex; justify-content:space-between;">
            <span style="color:#aaa; font-size:0.8rem;">KALIMAT TERBENTUK:</span>
            <div>
                <button onclick="addSpace()" style="background:#333; border:1px solid #555; color:white; padding:5px 10px; cursor:pointer;">Spasi</button>
                <button onclick="clearAll()" style="background:#333; border:1px solid #555; color:white; padding:5px 10px; cursor:pointer;">Hapus</button>
            </div>
        </div>
        <div class="sentence-text" id="final-sentence">...</div>
    </div>

    <div class="main-wrapper">
        <div class="left-panel">
            <div class="video-box">
                <video id="video" playsinline></video>
                <canvas id="canvas"></canvas>
                <div id="overlay" class="overlay-status">
                    <div style="font-size:3rem; margin-bottom:10px;">üëÅÔ∏è</div>
                    <div style="font-weight:bold; font-size:1.2rem;">MENGANALISIS...</div>
                    <div class="timer-bar"><div class="timer-fill" id="ov-bar"></div></div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="table-container">
                <table id="history-table">
                    <thead><tr><th width="40">#</th><th>Keputusan AI</th><th>Validasi (Alfabet)</th></tr></thead>
                    <tbody id="table-body"></tbody>
                </table>
                <div id="empty-msg" style="text-align:center; padding:30px; color:#555;">Kosong.</div>
            </div>
        </div>
    </div>

    <div class="dictionary-section">
        <div class="dict-title">üìö KAMUS REFERENSI (A-Z)</div>
        <div class="dict-grid" id="dict-grid"></div>
    </div>

    <script>
        // GLOBALS
        let USER_API_KEY = localStorage.getItem("GEMINI_API_KEY") || "";
        let CURRENT_MODEL = localStorage.getItem("GEMINI_MODEL") || "";

        // UI ELEMENTS
        const keyModal = document.getElementById('keyModal');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const btnFetch = document.getElementById('btnFetch');
        const modelSelectionArea = document.getElementById('modelSelectionArea');
        const aiModelSelect = document.getElementById('aiModelSelect');
        const statusMsg = document.getElementById('statusMsg');
        const modelBadge = document.getElementById('modelBadge');
        const captureModal = document.getElementById('captureModal');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const overlay = document.getElementById('overlay');
        const ovBar = document.getElementById('ov-bar');
        const tableBody = document.getElementById('table-body');
        const emptyMsg = document.getElementById('empty-msg');
        const finalSentence = document.getElementById('final-sentence');
        const liveToggle = document.getElementById('live-toggle');
        const modeSelect = document.getElementById('mode-select');
        const modalImg = document.getElementById('modalImg');

        // --- 1. AUTO DETECT CONFIG ---
        if(USER_API_KEY) {
            apiKeyInput.value = USER_API_KEY;
            if(CURRENT_MODEL) {
                keyModal.style.display = "none";
                modelBadge.innerText = "‚öôÔ∏è " + CURRENT_MODEL.replace("gemini-", "");
            }
        }

        async function fetchModels() {
            const key = apiKeyInput.value.trim();
            if(!key) return alert("Isi API Key dulu!");

            statusMsg.className = "status-msg loading";
            statusMsg.innerText = "Menghubungi Google...";
            btnFetch.style.display = "none";

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${key}`);
                const data = await response.json();

                if (data.error) throw new Error(data.error.message);
                if(!data.models) throw new Error("Tidak ada model ditemukan.");

                const validModels = data.models.filter(m => 
                    m.supportedGenerationMethods.includes("generateContent") &&
                    (m.name.includes("1.5") || m.name.includes("pro") || m.name.includes("flash"))
                );

                aiModelSelect.innerHTML = "";
                validModels.forEach(m => {
                    const cleanName = m.name.replace("models/", "");
                    const isSelected = (cleanName === CURRENT_MODEL) ? "selected" : "";
                    aiModelSelect.innerHTML += `<option value="${cleanName}" ${isSelected}>${m.displayName} (${m.version})</option>`;
                });
                // Fallback option
                aiModelSelect.innerHTML += `<option value="gemini-robotics-er-1.5-preview">Gemini Experimental (Region Free)</option>`;

                modelSelectionArea.style.display = "block";
                statusMsg.className = "status-msg success";
                statusMsg.innerText = "Kunci Valid! Silakan pilih model.";

            } catch (err) {
                statusMsg.className = "status-msg error";
                statusMsg.innerText = "Gagal: " + err.message;
                btnFetch.style.display = "block";
            }
        }

        function saveSettings() {
            const key = apiKeyInput.value.trim();
            const model = aiModelSelect.value;
            if(key && model) {
                USER_API_KEY = key;
                CURRENT_MODEL = model;
                localStorage.setItem("GEMINI_API_KEY", key);
                localStorage.setItem("GEMINI_MODEL", model);
                modelBadge.innerText = "‚öôÔ∏è " + model.replace("gemini-", "");
                keyModal.style.display = "none";
                alert("Tersimpan! Model: " + model);
            }
        }

        function changeKey() {
            keyModal.style.display = "flex";
            modelSelectionArea.style.display = "none";
            btnFetch.style.display = "block";
            statusMsg.innerText = "";
        }

        // --- 2. INIT KAMUS ---
        function initDictionary() {
            const grid = document.getElementById('dict-grid');
            const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            let html = "";
            for (let char of alphabet) {
                html += `
                <div class="dict-item">
                    <img src="pic/${char}.png" class="dict-img" onerror="this.src='https://placehold.co/100x100/000/FFF?text=${char}'">
                    <div class="dict-label">${char}</div>
                </div>`;
            }
            grid.innerHTML = html;
        }
        initDictionary();

        // --- 3. PROMPT SYSTEM ---
        function getSystemPrompt(mode) {
            if (mode === 'ALPHABET') {
                return `
                Role: Detektor Forensik Abjad BISINDO (A-Z).
                TASK (GEOMETRY + MOTION):
                1. SANGAT PENTING: Lihat GARIS PINK (Jejak Gerakan).
                   - Jika jejak membentuk 'Z', itu huruf 'Z'.
                   - Jika jejak melengkung seperti 'J', itu huruf 'J'.
                2. Jika tidak ada jejak panjang, analisis bentuk jari statis.
                3. Bandingkan dengan database Abjad BISINDO.
                4. Tentukan 3 kandidat abjad.
                
                OUTPUT JSON ONLY:
                {
                    "final": "HURUF_TERBAIK",
                    "candidates": [
                        {"char": "A", "score": 90}, {"char": "B", "score": 10}, {"char": "C", "score": 5}
                    ]
                }`;
            } else {
                return `
                Role: Ahli Linguistik BISINDO.
                PROSES BERPIKIR:
                1. [BODY SCAN] Identifikasi lokasi landmark tubuh (Kepala, Wajah, Dada).
                2. [HAND LOCALIZATION] Tentukan posisi tangan relatif tubuh (Dada=SAYA/MAAF, Mulut=MAKAN/BICARA).
                3. [MOTION] Lihat jejak PINK. Gerakan berulang? Melingkar?
                4. [SYNTHESIS] Gabungkan Bentuk + Lokasi + Gerakan.

                OUTPUT JSON ONLY: { "text": "HASIL_TERJEMAHAN" }
                `;
            }
        }

        // STATE
        const STATES = { IDLE: 0, SCANNING: 1, COOLDOWN: 2 };
        let currentState = STATES.IDLE;
        let isLive = false;
        let handDetected = false;
        let scanTimer = 0;
        let globalScanCount = 0;
        let sentenceBuffer = "";
        let captureMap = {};
        let historyPoints = [];

        // MODAL VIEW
        function showCapture(id) { if(captureMap[id]) { modalImg.src = captureMap[id]; captureModal.style.display = "flex"; } }
        function closeCapture() { captureModal.style.display = "none"; }
        window.onclick = function(e) { if(e.target == captureModal) closeCapture(); }

        // UI ROW
        function createRow(id) {
            emptyMsg.style.display = "none";
            const row = document.createElement('tr');
            row.id = `row-${id}`;
            row.innerHTML = `<td style="color:#888">#${id}</td><td style="color:#ffeb3b">‚åõ Loading...</td><td>...</td>`;
            tableBody.prepend(row);
        }

        function updateRow(id, data, mode) {
            const cellRaw = document.querySelector(`#row-${id} td:nth-child(2)`);
            const cellValid = document.querySelector(`#row-${id} td:nth-child(3)`);
            if(!cellRaw) return;

            if (data.error) { cellRaw.innerHTML = `<span style='color:red'>${data.msg || "Gagal"}</span>`; return; }

            const viewBtn = `<div class="view-capture-btn" onclick="showCapture(${id})">üì∑</div>`;
            let mainText = "";

            if (mode === 'ALPHABET') {
                mainText = data.final;
                cellRaw.innerHTML = `<span class="col-raw">${mainText}</span> ${viewBtn}`;
                
                let candHTML = `<div class="candidates-row">`;
                if(data.candidates) {
                    data.candidates.forEach((c, i) => {
                        let win = i===0 ? "winner" : "";
                        candHTML += `
                        <div class="candidate-item ${win}">
                            <img src="pic/${c.char}.png" class="cand-img" onerror="this.style.display='none'">
                            <span class="cand-char">${c.char}</span>
                            <span class="cand-score">${c.score}%</span>
                        </div>`;
                    });
                }
                candHTML += `</div>`;
                cellValid.innerHTML = candHTML;
            } else {
                mainText = data.text;
                cellRaw.innerHTML = `<span class="col-raw">${mainText}</span> ${viewBtn}`;
                cellValid.innerHTML = `<span style="color:#555;">(Mode General)</span>`;
            }

            if (mainText.length > 1) {
                if (sentenceBuffer && !sentenceBuffer.endsWith(" ")) sentenceBuffer += " ";
                sentenceBuffer += mainText;
            } else {
                sentenceBuffer += mainText;
            }
            finalSentence.innerText = sentenceBuffer;
        }

        // API CALL
        async function processInBackground(base64, scanId) {
            if (!USER_API_KEY || !CURRENT_MODEL) { alert("Setup AI dulu!"); return; }

            const mode = modeSelect.value;
            const prompt = getSystemPrompt(mode);
            captureMap[scanId] = "data:image/jpeg;base64," + base64;
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${CURRENT_MODEL}:generateContent?key=${USER_API_KEY}`;

            const body = { contents: [{ parts: [{ text: prompt }, { inlineData: { mimeType: "image/jpeg", data: base64 } }] }] };

            try {
                const res = await fetch(API_URL, { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(body) });
                const rawData = await res.json();
                let text = rawData.candidates?.[0]?.content?.parts?.[0]?.text || "{}";
                text = text.replace(/```json|```/g, '').trim();
                const json = JSON.parse(text);
                updateRow(scanId, json, mode);
            } catch (e) {
                updateRow(scanId, { error: true, msg: e.message }, mode);
            }
        }

        // SCAN LOOP
        function processLoop() {
            if (!isLive) return;
            if (currentState === STATES.IDLE) {
                if (handDetected) { currentState = STATES.SCANNING; scanTimer = 0; overlay.classList.add('active'); historyPoints = []; } 
                else { overlay.classList.remove('active'); }
            } 
            else if (currentState === STATES.SCANNING) {
                if (!handDetected) { currentState = STATES.IDLE; return; }
                scanTimer += 2.5; ovBar.style.width = scanTimer + "%";
                if (scanTimer >= 100) {
                    globalScanCount++;
                    const base64 = canvas.toDataURL('image/jpeg', 0.7).split(',')[1];
                    createRow(globalScanCount);
                    processInBackground(base64, globalScanCount);
                    currentState = STATES.COOLDOWN;
                    setTimeout(() => { currentState = STATES.IDLE; overlay.classList.remove('active'); }, 1500);
                }
            }
            requestAnimationFrame(processLoop);
        }

        function drawArm(ctx, landmarks) {
            const wrist = landmarks[0]; const mid = landmarks[9];
            const w = ctx.canvas.width; const h = ctx.canvas.height;
            const dx = (wrist.x - mid.x) * w; const dy = (wrist.y - mid.y) * h;
            ctx.beginPath(); ctx.moveTo(wrist.x*w, wrist.y*h); 
            ctx.lineTo(wrist.x*w + dx*4, wrist.y*h + dy*4);
            ctx.lineWidth=15; ctx.strokeStyle="rgba(0,100,255,0.3)"; ctx.stroke();
        }

        function drawTrail(ctx, landmarks) {
            const tip = landmarks[8]; const w=ctx.canvas.width; const h=ctx.canvas.height;
            historyPoints.push({x: tip.x*w, y: tip.y*h});
            if(historyPoints.length > 20) historyPoints.shift();
            if(historyPoints.length > 1) {
                ctx.beginPath(); ctx.moveTo(historyPoints[0].x, historyPoints[0].y);
                for(let i=1; i<historyPoints.length; i++) ctx.lineTo(historyPoints[i].x, historyPoints[i].y);
                ctx.lineWidth=6; ctx.strokeStyle="rgba(255,20,147,0.8)"; ctx.stroke();
            }
        }

        function onResults(results) {
            if (currentState === STATES.COOLDOWN) return;
            canvas.width = video.videoWidth; canvas.height = video.videoHeight;
            ctx.save(); ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);

            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                handDetected = true;
                for (const lm of results.multiHandLandmarks) {
                    drawArm(ctx, lm); drawTrail(ctx, lm);
                    drawConnectors(ctx, lm, HAND_CONNECTIONS, {color: '#00e676', lineWidth: 3});
                    drawLandmarks(ctx, lm, {color: '#fff', lineWidth: 2});
                }
            } else { 
                handDetected = false; 
                if(currentState !== STATES.SCANNING) historyPoints = []; 
            }
            ctx.restore();
        }

        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        hands.setOptions({ maxNumHands: 2, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        hands.onResults(onResults);

        const camera = new Camera(video, { onFrame: async () => { await hands.send({image: video}); }, width: 480, height: 360 });
        camera.start();

        liveToggle.addEventListener('change', (e) => {
            if(!USER_API_KEY) { alert("Setup API Key dulu!"); e.target.checked = false; changeKey(); return; }
            isLive = e.target.checked;
            if (isLive) { currentState = STATES.IDLE; processLoop(); } else { overlay.classList.remove('active'); }
        });

        function addSpace() { sentenceBuffer += " "; finalSentence.innerText = sentenceBuffer; }
        function clearAll() { sentenceBuffer=""; finalSentence.innerText="..."; tableBody.innerHTML=""; emptyMsg.style.display="block"; globalScanCount=0; }
    </script>
</body>
</html>
